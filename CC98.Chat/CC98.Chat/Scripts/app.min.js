var AuthController=function(){function n(n,t,i,r){this.$rootScope=n;this.$location=t;this.$window=i;this.$cc98Authorization=r;this.handleCore()}return n.prototype.handleCore=function(){var r=this,u=this.$location.hash(),n=Utility.deparam(u),t=n.access_token,i=n.token_type;this.returnUrl=n.state;t&&i&&console.info("成功从 Hash 中提取了授权令牌信息。");this.$rootScope.$on(Events.logOnEnd,function(n,t){return r.handleUserLogOnChanged(t)});this.$cc98Authorization.trySetTokenInfo(t,i)},n.prototype.handleUserLogOnChanged=function(){console.debug("正在重定向到 %s",this.returnUrl);this.$location.hash("");this.$location.path(this.returnUrl)},n}(),CC98AuthorizationService=function(){function n(n,t,i,r,u,f,e){this.accessTokenKey="access_token";this.tokenTypeKey="type";this.isLoggedOnInternal=!1;this.myInfoInternal=null;console.debug("正在构建 CC98 身份认证服务...");this.$siteUri=n;this.$logonUri=t;this.$apiUri=i;this.$cc98ClientId=r;this.$window=u;this.$http=f;this.$rootScope=e}return n.prototype.buildOAuthRedirectUri=function(n,t){var i=Utility.combineUri(this.$siteUri,"/Auth"),r=t,u=Utility.stringFormat("/OAuth/Authorize?response_type=token&scope=getmessage* setmessage*&client_id={0}&redirect_uri={1}&state={2}",encodeURIComponent(n),encodeURIComponent(i),encodeURIComponent(r));return Utility.combineUri(this.$logonUri,u)},Object.defineProperty(n.prototype,"accessToken",{get:function(){return this.accessTokenInternal},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenType",{get:function(){return this.tokenTypeInternal},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLoggedOn",{get:function(){return this.isLoggedOnInternal},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"myInfo",{get:function(){return this.myInfoInternal},enumerable:!0,configurable:!0}),n.prototype.handleAccessToken=function(){},n.prototype.saveTokenToStorage=function(){this.$window.localStorage[this.accessTokenKey]=this.accessTokenInternal;this.$window.localStorage[this.tokenTypeKey]=this.tokenTypeInternal},n.prototype.loadTokenFromStorage=function(){return this.accessTokenInternal=this.$window.localStorage[this.accessTokenKey],this.tokenTypeInternal=this.$window.localStorage[this.tokenTypeKey],this.accessTokenInternal!==null&&this.tokenTypeInternal!==null},n.prototype.loadMyInfoUsingToken=function(){var n=this,t;console.debug("try loading user info from token...");t={headers:{Authorization:Utility.stringFormat("{0} {1}",this.tokenTypeInternal,this.accessTokenInternal)}};this.$http.get(Utility.combineUri(this.$apiUri,"/Me/Basic"),t).success(function(t){n.isLoggedOnInternal=!0;n.myInfoInternal=t;n.saveTokenToStorage();n.$rootScope.$broadcast(Events.logOnEnd,!0);console.info("succeessfully loaded user info.")}).error(function(){n.$rootScope.$broadcast(Events.logOnEnd,!1);console.warn("error loading user info.")})},n.prototype.trySetTokenInfo=function(n,t){console.debug("正在设置用户令牌 ...");this.accessTokenInternal=n;this.tokenTypeInternal=t;this.loadMyInfoUsingToken()},n.prototype.handleCallback=function(){var n={},t=n[this.accessTokenKey],i=n[this.tokenTypeKey];this.$window.localStorage[this.accessTokenKey]=t;this.$window.localStorage[this.tokenTypeKey]=i},n.prototype.tryAutoLogOn=function(){return(console.debug("正在尝试自动登录 ..."),!this.loadTokenFromStorage())?(console.debug("找不到登录令牌信息"),!1):(this.loadMyInfoUsingToken(),!0)},n.prototype.logOn=function(n){this.$window.location.href=this.buildOAuthRedirectUri(this.$cc98ClientId,n)},n.prototype.logOff=function(){this.isLoggedOnInternal=!1;this.myInfoInternal=null},n}(),Utility,Events,UserInfo,Message,MessageType;(function(n){function t(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];return n.replace(/\{(\d+)\}/g,function(n,t){return i[t]})}function i(n){return n!==undefined&&n!==null&&n!==""}function r(n){return Object.getOwnPropertyNames(n).length===0}function u(n){var i=Object.getOwnPropertyNames(n),t=[];return $.each(i,function(i,r){t.push(n[r])}),t}function f(n,t){return n[n.length-1]!=="/"&&(n+="/"),t[0]==="/"&&(t=t.substring(1)),n+t}function e(n){var t={},i=n.split("&");return $.each(i,function(n,i){var r=i.indexOf("="),u,f;r!==-1?(u=decodeURIComponent(i.substring(0,r)),f=decodeURIComponent(i.substring(r+1))):(u=decodeURIComponent(i),f=null);t[u]=f}),t}n.stringFormat=t;n.hasValue=i;n.isEmpty=r;n.values=u;n.combineUri=f;n.deparam=e})(Utility||(Utility={})),function(n){n.logOnEnd="logOnEnd";n.serverConnectEnd="serverConnectEnd";n.userInfoUpdated="userInfoUpdated";n.systemMessage="systemMessage";n.togglePresentationMode="togglePresentationMode";n.setPresentationData="setPresentationData"}(Events||(Events={}));UserInfo=function(){function n(){}return n}();Message=function(){function n(){}return n}(),function(n){n[n.Others=0]="Others";n[n.Me=1]="Me";n[n.System=2]="System"}(MessageType||(MessageType={}));var ChatGroupInfo=function(){function n(){this.members=[]}return n}(),CC98UserInfoService=function(){function n(n,t,i){this.userDic={};this.$apiUri=n;this.$rootScope=t;this.$http=i}return n.prototype.getUserInfoFromServer=function(n){var t=this,i;console.debug("正在尝试获取用户信息，用户名 = %s",n);i=Utility.combineUri(this.$apiUri,Utility.stringFormat("/user/name/{0}",encodeURIComponent(n)));this.$http.get(i).success(function(i){console.debug("成功获取用户信息，用户名 = %s",n);var r=t.userDic[n];r.name=i.name;r.id=i.id;r.portraitUrl=i.portraitUrl;t.$rootScope.$broadcast(Events.userInfoUpdated,r)}).error(function(){console.warn("获取用户信息失败，用户名 = %s",n)})},n.prototype.pickUserInfo=function(n){console.debug("正在检索用户信息，用户名 = %s",n);var t=this.userDic[n];return t?t:(t=new UserInfo,t.id=0,t.name=n,t.portraitUrl=null,this.userDic[n]=t,this.getUserInfoFromServer(n),t)},n}(),SignalRService=function(){function n(n,t,i){var r=this;this.isConnectedInternal=!1;console.debug("正在初始化 SignalR 服务 ...");this.$apiUri=n;this.$rootScope=t;this.$cc98Authorizaion=i;this.signalR=$.connection;this.initializeHub();this.$rootScope.$on(Events.logOnEnd,function(){return r.handleLogOnEvent()})}return n.prototype.handleLogOnEvent=function(){var n=this.$cc98Authorizaion.myInfo;this.$cc98Authorizaion.isLoggedOn},Object.defineProperty(n.prototype,"messageHub",{get:function(){return this.signalR.messageHub},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isConnected",{get:function(){return this.isConnectedInternal},enumerable:!0,configurable:!0}),n.prototype.setUserAuthorization=function(){this.signalR.hub.qs=this.$cc98Authorizaion.isLoggedOn?{Authorization:Utility.stringFormat("{0} {1}",this.$cc98Authorizaion.tokenType,this.$cc98Authorizaion.accessToken)}:{}},n.prototype.initializeHub=function(){var t=this,n=Utility.combineUri(this.$apiUri,"/signalR");console.debug("正在配置 SignalR，地址 = %s",n);this.signalR.hub.url=n;this.signalR.hub.disconnected(function(){return t.handleDisconnnected()})},n.prototype.start=function(){var n=this;this.signalR.hub.state!==4&&this.signalR.hub.stop();this.setUserAuthorization();$.connection.hub.logging=!0;$.connection.hub.start().done(function(){console.debug("已经连接到服务器。");n.isConnectedInternal=!0;n.$rootScope.$broadcast(Events.serverConnectEnd,!0)}).fail(function(){console.debug("连接服务器失败");n.isConnectedInternal=!1;n.$rootScope.$broadcast(Events.serverConnectEnd,!1)})},n.prototype.handleDisconnnected=function(){this.$rootScope.$broadcast("serverDisconnected")},n.prototype.run=function(n){this.isConnected?n():(this.$rootScope.$on(Events.serverConnectEnd,function(t){t&&n()}),this.start())},n}(),SystemMessageService=function(){function n(n){console.debug("正在初始化消息服务 ...");this.$rootScope=n}return n.prototype.showMessage=function(n){console.log(Utility.stringFormat("准备显示消息: {0}",n));this.$rootScope.$broadcast(Events.systemMessage,n)},n}(),HomeController=function(){function n(n,t,i){var r=this;this.isLoggedOn=!1;this.groups={};console.debug("正在进入首页控制器 ...");this.$scope=n;this.$signalR=t;this.$cc98Authorization=i;this.attachHubEvents();this.$scope.$on(Events.logOnEnd,function(){return r.handleLogOnEvent()});this.$scope.$on(Events.serverConnectEnd,function(){return r.handleServerConnectEnd()});this.$cc98Authorization.tryAutoLogOn()||t.start()}return n.prototype.handleServerConnectEnd=function(){console.debug("检测到服务器连接状态更改");this.syncGroups()},n.prototype.handleLogOnEvent=function(){this.isLoggedOn=this.$cc98Authorization.isLoggedOn;this.$signalR.start()},n.prototype.logOn=function(){this.$cc98Authorization.logOn("/Home")},n.prototype.getDisplayTitle=function(n){return Utility.hasValue(n.title)?n.title:n.name},Object.defineProperty(n.prototype,"hasGroups",{get:function(){return!Utility.isEmpty(this.groups)},enumerable:!0,configurable:!0}),n.prototype.syncGroups=function(){var n=this;this.$signalR.messageHub.server.getGroups().done(function(t){console.info("成功获取组信息，数量 = %d",t.length);var i={};$.each(t,function(n,t){i[t.name]=t});n.groups=i;n.$scope.$apply("groups");n.$scope.$apply("hasGroups")}).fail(function(){console.warn("获取组信息时发生错误。")})},n.prototype.handleGroupCreated=function(n){console.debug("检测到创建新组");this.groups[n.name]=n;this.$scope.$apply("groups");this.$scope.$apply("hasGroups")},n.prototype.handleGroupDestroyed=function(n){console.debug("检测到组销毁");delete this.groups[n];this.$scope.$apply("groups");this.$scope.$apply("hasGroups")},n.prototype.attachHubEvents=function(){var n=this;this.$signalR.messageHub.client.groupCreated=function(t){return n.handleGroupCreated(t)};this.$signalR.messageHub.client.groupDestroyed=function(t){return n.handleGroupDestroyed(t)}},n}(),MainController=function(){function n(n,t,i,r){var u=this;this.isPresentationMode=!1;this.groupName=null;this.title=null;this.errors=[];this.$siteUri=n;this.$rootScope=t;this.$scope=i;this.$timeout=r;this.$rootScope.$on(Events.systemMessage,function(n,t){return u.handleNewSystemMessage(t)});this.$rootScope.$on(Events.togglePresentationMode,function(n,t){return u.handleTogglePresentationModeEvent(t)});this.$rootScope.$on(Events.setPresentationData,function(n,t,i){u.groupName=t;u.title=i});this.updateUI()}return n.prototype.handleTogglePresentationModeEvent=function(n){this.isPresentationMode=n;this.$scope.$apply("isPresentationMode");this.updateUI()},Object.defineProperty(n.prototype,"displayLink",{get:function(){return Utility.combineUri(this.$siteUri,Utility.stringFormat("/Group/{0}",encodeURIComponent(this.groupName)))},enumerable:!0,configurable:!0}),n.prototype.updateUI=function(){},n.prototype.handleNewSystemMessage=function(n){var t=this;this.errors.push(n);this.$scope.$apply("errors");this.$timeout(function(){t.errors.splice(0,1)},2e3,!0)},n}(),ChatController=function(){function n(n,t,i,r,u,f,e,o){var s=this;this.chatGroupInfo=null;this.newMessage=null;this.isLoggedOn=!1;this.myInfo=null;this.myUserInfo=null;this.isPresentationMode=!1;this.members={};this.messages=[];this.groupName=null;console.debug("正在初始化聊天控制器...");this.$routeParams=n;this.$scope=t;this.$rootScope=i;this.$window=r;this.$cc98Authorization=u;this.$cc98UserInfo=f;this.$signalR=e;this.$systemMessage=o;this.bindHubEvents();this.groupName=n.groupName;t.$on(Events.serverConnectEnd,function(){return s.handleServerConnectEndEvent()});t.$on(Events.userInfoUpdated,function(){return s.handleUserInfoUpdatedEvent()});t.$on(Events.togglePresentationMode,function(n,t){return s.handleTogglePresentationModeEvent(t)});this.$cc98Authorization.tryAutoLogOn()||this.$signalR.start();t.$on(Events.logOnEnd,function(){return s.handleLogOnEvent()})}return Object.defineProperty(n.prototype,"displayTitle",{get:function(){return this.chatGroupInfo===null||this.chatGroupInfo===undefined?this.groupName:this.chatGroupInfo.title===null||this.chatGroupInfo.title===""?this.chatGroupInfo.name:this.chatGroupInfo.title},enumerable:!0,configurable:!0}),n.prototype.handleTogglePresentationModeEvent=function(n){this.isPresentationMode=n;this.$scope.$apply("isPresentationMode")},n.prototype.sendNewMessage=function(){var n=this;this.$signalR.isConnected&&this.$signalR.messageHub.server.sendGroupMessage(this.groupName,this.newMessage).done(function(){n.newMessage=null;n.$scope.$apply("newMessage")}).fail(function(){})},n.prototype.handleUserInfoUpdatedEvent=function(){},n.prototype.bindHubEvents=function(){var n=this,t=this.$signalR.messageHub.client;t.userEnterGroup=function(t,i){return n.handleUserEnterGroupMessage(t,i)};t.userExitGroup=function(t,i){return n.handleUserExitGroupMessage(i,t)};t.newGroupMessage=function(t,i,r){return n.handleNewGroupMessage(t,i,r)}},n.prototype.handleUserExitGroupMessage=function(n,t){(console.debug("接收到用户离开讨论组消息，组名 = %s, 用户名e = %s",n,t),n===this.groupName)&&(Utility.hasValue(t)?(delete this.members[t],this.$scope.$apply("members"),this.$scope.$apply("hasMembers"),this.$systemMessage.showMessage(Utility.stringFormat("用户 {0} 离开了讨论组。",t))):this.$systemMessage.showMessage("一位来宾离开了讨论组。"))},n.prototype.handleUserEnterGroupMessage=function(n,t){(console.debug("接收到用户进入讨论组消息，组名 = %s, 用户名 = %s",n,t),n===this.groupName)&&(Utility.hasValue(t)?(this.members[t]=this.$cc98UserInfo.pickUserInfo(t),this.$scope.$apply("members"),this.$scope.$apply("hasMembers"),this.$systemMessage.showMessage(Utility.stringFormat("用户 {0} 进入了讨论组。",t))):this.$systemMessage.showMessage("一位来宾进入了讨论组。"))},n.prototype.handleNewGroupMessage=function(n,t,i){if(console.debug("接收到新的发言，组名 = %s, 用户名 = %s, 内容 = %s",n,t,i),n===this.groupName){var r=new Message;r.time=new Date;r.user=this.$cc98UserInfo.pickUserInfo(t);r.content=i;r.messageType=this.myInfo!==null&&t===this.myInfo.name?MessageType.Me:MessageType.Others;$("#scrollable2").animate({scrollTop:$(".container").height()},1e3);this.messages.push(r);this.messages.length>1e3&&this.messages.shift();this.$scope.$apply("messages")}},Object.defineProperty(n.prototype,"isAdmin",{get:function(){if(this.chatGroupInfo===null||this.myInfo===null)return!1;var n=!1;return $.each(this.myInfo.roles,function(t,i){i.toLowerCase()==="administrators"&&(n=!0)}),n||this.chatGroupInfo.managerName.toLowerCase()===this.myInfo.name.toLowerCase()},enumerable:!0,configurable:!0}),n.prototype.generateMessageString=function(){var n="";return $.each(this.messages,function(t,i){var r=Utility.stringFormat("时间：{0}\r\n作者：{1}\r\n内容：{2}\r\n\r\n",i.time,i.user.name,i.content);n+=r}),n},n.prototype.save=function(){var n=this.generateMessageString();this.$window.clipboardData.setData("Text",n)?alert("内容已经成功复制到剪贴板。"):alert("无法将内容复制到剪贴板，请确保你的浏览器没有阻止网站访问剪贴板。")},n.prototype.tryEnterGroup=function(){console.debug("尝试进入聊天组...");this.$signalR.messageHub.server.enterGroup(this.groupName).done(function(){console.info("进入聊天组成功。")}).fail(function(){console.warn("进入聊天组失败")})},n.prototype.executePostConnect=function(){this.loadChatInfo();this.tryEnterGroup()},n.prototype.handleServerConnectEndEvent=function(){this.$signalR.isConnected&&this.executePostConnect()},n.prototype.handleLogOnEvent=function(){this.$signalR.start();this.updateMyInfo();this.$scope.$apply("isLoggeOn");this.$scope.$apply("myInfo");this.$scope.$apply("myUserInfo");this.$scope.$apply("isAdmin")},n.prototype.logOn=function(){var n=Utility.stringFormat("/Group/{0}",encodeURIComponent(this.groupName));this.$cc98Authorization.logOn(n)},n.prototype.updateMyInfo=function(){this.isLoggedOn=this.$cc98Authorization.isLoggedOn;this.myInfo=this.$cc98Authorization.myInfo;this.myUserInfo=this.myInfo!==null?this.$cc98UserInfo.pickUserInfo(this.myInfo.name):null},n.prototype.closeGroup=function(){var n=this;this.$signalR.messageHub.server.destroyGroup(this.groupName).done(function(){n.$window.close()}).fail(function(){})},n.prototype.togglePresentationMode=function(){CC98Chat.isPresentationMode=!CC98Chat.isPresentationMode;CC98Chat.isPresentationMode?$("#scrollable2").css("overflow-y","hidden"):$("#scrollable2").css("overflow-y","scroll");this.$rootScope.$broadcast(Events.togglePresentationMode,CC98Chat.isPresentationMode)},n.prototype.loadChatInfo=function(){var n=this;console.debug("开始加载聊天组信息...");this.$signalR.isConnected&&this.$signalR.messageHub.server.getGroup(this.groupName).done(function(t){console.info("加载聊天组信息成功。");n.chatGroupInfo=t;n.$rootScope.$broadcast(Events.setPresentationData,n.groupName,n.displayTitle);n.$scope.$apply("chatGroupInfo");n.$scope.$apply("displayTitle");n.$scope.$apply("isAdmin");n.syncUserInfo()}).fail(function(){console.warn("加载聊天组信息失败。")})},n.prototype.syncUserInfo=function(){var t=this,n={};$.each(this.chatGroupInfo.members,function(i,r){n[r.name]=t.$cc98UserInfo.pickUserInfo(r.name)});this.members=n;this.$scope.$apply("members");this.$scope.$apply("hasMembers")},Object.defineProperty(n.prototype,"hasMembers",{get:function(){return!Utility.isEmpty(this.members)},enumerable:!0,configurable:!0}),n}(),CreateGroupController=function(){function n(n,t,i,r,u){this.$window=n;this.$location=t;this.$scope=i;this.$signalR=r;this.$systemMessage=u}return n.prototype.create=function(){var n=this;this.$signalR.isConnected?this.$signalR.messageHub.server.createGroup(this.name,this.title,this.description).done(function(){n.$systemMessage.showMessage("创建讨论组成功。");n.$location.path(Utility.stringFormat("/Group/{0}",encodeURIComponent(n.name)));n.clear()}).fail(function(t){n.$systemMessage.showMessage(Utility.stringFormat("创建讨论组失败：{0}",t))}):console.error("SignalR 未连接，不能执行创建操作。")},n.prototype.clear=function(){this.name=null;this.title=null;this.description=null},n}(),CC98Chat;(function(n){function i(n,i){for(var u,f=[],r=2;r<arguments.length;r++)f[r-2]=arguments[r];return u=f,u.push(i),t.controller(n,u)}function r(n,i){for(var u,f=[],r=2;r<arguments.length;r++)f[r-2]=arguments[r];return u=f,u.push(i),t.service(n,u)}function u(n){for(var r,u=[],i=1;i<arguments.length;i++)u[i-1]=arguments[i];return r=u,r.push(n),t.config(r)}function f(n,t){console.debug("正在配置应用程序路径 ...");t.html5Mode({enabled:!0});n.when("/Home",{templateUrl:"home.html"}).when("/Group/:groupName",{templateUrl:"chat.html"}).when("/Auth",{templateUrl:"auth.html"}).otherwise({redirectTo:"/Home"});console.debug("路径配置完成 ...")}console.debug("正在初始化 CC98 Chat 主模块...");var t=angular.module("cc98-chat",["ngRoute","ngAnimate"]);n.isPresentationMode=!1;u(f,"$routeProvider","$locationProvider");t.constant("$siteUri",$("html").data("site-uri"));t.constant("$apiUri",$("html").data("api-uri"));t.constant("$logonUri",$("html").data("logon-uri"));t.constant("$cc98ClientId","91b3ac76-0919-4fde-85d0-91ffde409a45");r("$systemMessage",SystemMessageService,"$rootScope");r("$signalR",SignalRService,"$apiUri","$rootScope","$cc98Authorization");r("$cc98UserInfo",CC98UserInfoService,"$apiUri","$rootScope","$http");r("$cc98Authorization",CC98AuthorizationService,"$siteUri","$logonUri","$apiUri","$cc98ClientId","$window","$http","$rootScope");i("MainController",MainController,"$siteUri","$rootScope","$scope","$timeout");i("HomeController",HomeController,"$scope","$signalR","$cc98Authorization");i("AuthController",AuthController,"$rootScope","$location","$window","$cc98Authorization");i("ChatController",ChatController,"$routeParams","$scope","$rootScope","$window","$cc98Authorization","$cc98UserInfo","$signalR","$systemMessage");i("CreateGroupController",CreateGroupController,"$window","$location","$scope","$signalR","$systemMessage")})(CC98Chat||(CC98Chat={}))
//# sourceMappingURL=app.min.js.map
